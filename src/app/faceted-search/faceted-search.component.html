<ng-template #searchContainer>
  <div class="facet-container">
    <!-- Top right basic/advanced toggle -->
    <div class="filter-toggle">
      <a href="#" (click)="$event.preventDefault(); toggleMode()">
        {{ isAdvancedMode() ? 'Basic Search' : 'Advanced Search' }}
      </a>
    </div>

    <!-- Basic Mode search -->
    <div *ngIf="!isAdvancedMode()" class="search-box">
      <div class="input-wrapper">
        <input
          type="text"
          class="facet-input inline"
          placeholder="Search..."
          [value]="basicSearchText()"
          (input)="onBasicSearchInput($any($event.target).value)"
        />
      </div>
    </div>

    <!-- Advanced Mode search -->
    <div *ngIf="isAdvancedMode()" class="search-box">
      <div class="input-wrapper">
        <!-- Selected column token + input -->
        <ng-container *ngIf="selectedColumn() as col">
          <span class="token">
            {{ col.label }}:
            <span class="value-wrapper">
              <input
                #valueInput
                type="text"
                class="facet-input inline"
                [placeholder]="col.type === 'select' ? 'Select value' : 'Enter value'"
                [value]="inputValue()"
                (input)="onSearchInput($any($event.target).value)"
                (keydown)="onValueKeydown($event)"
                (focus)="onFocus()"
                (keydown.backspace)="$event.stopPropagation()"
              />

              <ul
                class="dropdown value-dropdown"
                *ngIf="showDropdown() && col.type === 'select' && possibleValues().length"
              >
                <li
                  *ngFor="let val of possibleValues(); let i = index"
                  [class.highlighted]="i === highlightedIndex()"
                  (click)="onRowClick($event, col, val)"
                >
                  <div class="value-option" (click)="$event.stopPropagation()">
                    <input
                      *ngIf="col?.multi"
                      type="checkbox"
                      [checked]="tempSelectedValues().get(col.map)?.has(val.value)"
                      (click)="onCheckboxClick($event, col, val)"
                    />
                    <span (click)="onRowClick($event, col, val)" [innerHTML]="highlightMatch(val.value)"></span>
                  </div>
                </li>

                <!-- Apply + Close buttons for multi-select -->
                <li *ngIf="col.multi" class="apply-row no-hover">
                  <div class="button-row">
                    <button
                      class="dropdown-btn close-btn"
                      (click)="cancelMultiSelection(); $event.stopPropagation(); $event.preventDefault()"
                    >
                      Close
                    </button>
                    <button
                      class="dropdown-btn apply-btn"
                      (click)="applyMultiSelection(); $event.stopPropagation(); $event.preventDefault()"
                    >
                      Apply
                    </button>
                  </div>
                </li>
              </ul>
            </span>
            <button (click)="removeColumn()">×</button>
          </span>
        </ng-container>

        <!-- Placeholder input when no column selected -->
        <ng-container *ngIf="!selectedColumn()">
          <input
            #searchInput
            type="text"
            class="facet-input"
            [placeholder]="'Choose options...'"
            [value]="inputValue()"
            (focus)="onFocus()"
            (input)="onSearchInput($any($event.target).value)"
            (keydown)="onColumnKeydown($event)"
          />
        </ng-container>
      </div>

      <!-- Column dropdown -->
      <ul class="dropdown" *ngIf="showDropdown() && !selectedColumn()">
        <li
          *ngFor="let col of filteredColumns(); let i = index"
          [class.highlighted]="i === highlightedIndex()"
          (click)="selectColumn(col)"
        >
          <span [innerHTML]="highlightMatch(col.label)"></span>
        </li>
      </ul>
    </div>
  </div>
</ng-template>

<!-- Chips container moved OUTSIDE facet-container -->
<ng-template #pillsContainer>
  <div class="chips-bar" *ngIf="isAdvancedMode() && hasFilters()">
    <div class="chips-container">
      <!-- Left: Clear All -->
      <div class="chips-side left" [class.hidden]="!hasFilters()">
        <a (click)="clearAll()">Clear All</a>
      </div>

      <!-- Middle: dynamic chip list -->
      <div #chipsMiddle class="chips-middle">
        <ng-container *ngFor="let group of visibleGroups()">
          <span class="chip" [title]="group.label + ': ' + (group.values.join(', ') || '')">
            <span class="chip-label">{{ group.label }}</span>
            <span class="chip-divider">:</span>
            <span class="chip-value">{{ group.values.join(', ') }}</span>
            <button (click)="removeChip(group.map)">×</button>
          </span>
        </ng-container>
      </div>

      <!-- Right: More -->
      <div class="chips-side right" [class.hidden]="!hiddenGroups().length">
        <span class="more-text" (click)="toggleMoreDropdown()">
          {{ moreDropdownOpen() ? '- ' + hiddenGroups().length + ' Less' : '+ ' + hiddenGroups().length + ' More' }}
        </span>
        <ul *ngIf="moreDropdownOpen()" class="more-dropdown">
          <li *ngFor="let group of hiddenGroups()">
            <span class="chip" [title]="group.label + ': ' + group.values.join(', ')">
              <span class="chip-label">{{ group.label }}</span>
              <span class="chip-divider">:</span>
              <span class="chip-value">{{ group.values.join(', ') }}</span>
              <button (click)="removeChip(group.map)">×</button>
            </span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</ng-template>
