<div class="facet-container">
  <!-- Top right basic/advanced toggle -->
  <div class="filter-toggle">
    <a href="#" (click)="$event.preventDefault(); toggleMode()">
      {{ isAdvancedMode() ? 'Basic Search' : 'Advanced Search' }}
    </a>
  </div>

  <!-- Basic Mode search -->
  <div *ngIf="!isAdvancedMode()" class="search-box">
    <div class="input-wrapper">
      <input
        type="text"
        class="facet-input inline"
        placeholder="Search..."
        [value]="basicSearchText()"
        (input)="onBasicSearchInput($any($event.target).value)"
      />
    </div>
  </div>

  <!-- Advanced Mode search -->
  <div *ngIf="isAdvancedMode()" class="search-box">
    <div class="input-wrapper" (click)="onFocus()">
      <!-- Selected column token + input -->
      <ng-container *ngIf="selectedColumn() as col">
        <span class="token">
          {{ col.label }}:
          <span class="value-wrapper">
            <input
              #valueInput
              type="text"
              class="facet-input inline"
              [placeholder]="col.type === 'select' ? 'Select value' : 'Enter value'"
              [value]="inputValue()"
              (input)="onSearchInput($any($event.target).value)"
              (keydown)="onValueKeydown($event)"
              (keydown.backspace)="$event.stopPropagation()"
            />

            <ul
              class="dropdown value-dropdown"
              *ngIf="showDropdown() && col.type === 'select' && possibleValues().length"
            >
              <li
                *ngFor="let val of possibleValues(); let i = index"
                [class.highlighted]="i === highlightedIndex()"
                (click)="onRowClick($event, col, val)"
              >
                <div class="value-option" (click)="$event.stopPropagation()">
                  <input
                    *ngIf="col?.multi"
                    type="checkbox"
                    [checked]="tempSelectedValues().get(col.key)?.has(val)"
                    (click)="onCheckboxClick($event, col, val)"
                  />
                  <span (click)="onRowClick($event, col, val)" [innerHTML]="highlightMatch(val)"></span>
                </div>
              </li>

              <!-- Apply + Close buttons for multi-select -->
              <li *ngIf="col.multi" class="apply-row no-hover">
                <div class="button-row">
                  <button class="dropdown-btn close-btn" (click)="cancelMultiSelection()">Close</button>
                  <button class="dropdown-btn apply-btn" (click)="applyMultiSelection()">Apply</button>
                </div>
              </li>
            </ul>
          </span>
          <button (click)="removeColumn()">×</button>
        </span>
      </ng-container>

      <!-- Placeholder input when no column selected -->
      <ng-container *ngIf="!selectedColumn()">
        <input
          #searchInput
          type="text"
          class="facet-input"
          [placeholder]="'Add filter...'"
          [value]="inputValue()"
          (focus)="onFocus()"
          (input)="onSearchInput($any($event.target).value)"
          (keydown)="onColumnKeydown($event)"
        />
      </ng-container>
    </div>

    <!-- Column dropdown -->
    <ul class="dropdown" *ngIf="showDropdown() && !selectedColumn()">
      <li
        *ngFor="let col of filteredColumns(); let i = index"
        [class.highlighted]="i === highlightedIndex()"
        (click)="selectColumn(col)"
      >
        <span [innerHTML]="highlightMatch(col.label)"></span>
      </li>
    </ul>

    <!-- Chips -->
    <div class="chips">
      <span *ngIf="hasFilters()" class="clear-all" (click)="clearAll()">
        <a href="#">Clear All</a>
      </span>

      <!-- Use groupedFilters and show last N visible chips -->
      <ng-container *ngFor="let group of lastVisibleGroups()">
        <span class="chip" [title]="group.label + ': ' + (group.values.join(', ') || '')">
          <span class="chip-label">{{ group.label }}:</span>
          <span class="chip-value">{{ group.values.join(', ') }}</span>
          <button (click)="removeChip(group.key)">×</button>
        </span>
      </ng-container>

      <!-- Use moreGroups to show the previous N chips inside the more option -->
      <ng-container *ngIf="moreGroups().length > 0">
        <span class="more-wrapper">
          <span class="more-text" (click)="toggleMoreDropdown()">+ More</span>
          <ul *ngIf="moreDropdownOpen()" class="more-dropdown">
            <li *ngFor="let group of moreGroups()">
              <span class="chip" [title]="group.label + ': ' + group.values.join(', ')">
                <span class="chip-label">{{ group.label }}:</span>
                <span class="chip-value">{{ group.values.join(', ') }}</span>
                <button (click)="removeChip(group.key)">×</button>
              </span>
            </li>
          </ul>
        </span>
      </ng-container>
    </div>
  </div>
</div>
