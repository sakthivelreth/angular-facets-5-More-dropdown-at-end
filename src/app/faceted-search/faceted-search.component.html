<div class="facet-container">
  <div class="search-box">
    <div class="input-wrapper" (click)="onFocus()">
      <!-- Selected column token + input -->
      <ng-container *ngIf="selectedColumn() as col">
        <span class="token">
          {{ col.label }}:
          <span class="value-wrapper">
            <input
              #valueInput
              type="text"
              class="facet-input inline"
              [placeholder]="col.type === 'select' ? 'Select value' : 'Enter value'"
              [value]="inputValue()"
              (input)="onSearchInput($any($event.target).value)"
              (keydown.enter)="selectValueOnEnter()"
              (keydown)="onValueKeydown($event)"
              (keydown.backspace)="$event.stopPropagation()"
            />

            <ul
              class="dropdown value-dropdown"
              *ngIf="showDropdown() && col.type === 'select' && possibleValues().length"
            >
              <li
                *ngFor="let val of possibleValues(); let i = index"
                [class.highlighted]="i === highlightedIndex()"
                (click)="selectValue(val)"
              >
                <span [innerHTML]="highlightMatch(val)"></span>
              </li>
            </ul>
          </span>
          <button (click)="removeColumn()">×</button>
        </span>
      </ng-container>

      <!-- Placeholder input when no column selected -->
      <ng-container *ngIf="!selectedColumn()">
        <input
          #searchInput
          type="text"
          class="facet-input"
          [placeholder]="'Add filter...'"
          [value]="inputValue()"
          (focus)="onFocus()"
          (input)="onSearchInput($any($event.target).value)"
          (keydown.enter)="selectColumnOnEnter()"
          (keydown)="onColumnKeydown($event)"
        />
      </ng-container>
    </div>

    <!-- Column dropdown -->
    <ul class="dropdown" *ngIf="showDropdown() && !selectedColumn()">
      <li
        *ngFor="let col of filteredColumns(); let i = index"
        [class.highlighted]="i === highlightedIndex()"
        (click)="selectColumn(col)"
      >
        <span [innerHTML]="highlightMatch(col.label)"></span>
      </li>
    </ul>

    <!-- Chips -->
    <div class="chips">
      <span *ngIf="hasFilters()" class="clear-all" (click)="clearAll()">
        <a href="#">Clear All</a>
      </span>

      <ng-container *ngFor="let col of lastVisibleChips()">
        <span class="chip" [title]="col.label + ': ' + col.value">
          <span class="chip-label">{{ col.label }}</span>
          <span class="chip-value">{{ col.value }}</span>
          <button (click)="removeChip(col.key)">×</button>
        </span>
      </ng-container>

      <ng-container *ngIf="moreChips().length > 0">
        <span class="more-wrapper">
          <span class="more-text" (click)="toggleMoreDropdown()">+ More</span>
          <ul *ngIf="moreDropdownOpen()" class="more-dropdown">
            <li *ngFor="let col of moreChips()">
              <span class="chip" [title]="col.label + ': ' + col.value">
                <span class="chip-label">{{ col.label }}:</span>
                <span class="chip-value">{{ col.value }}</span>
                <button (click)="removeChip(col.key)">×</button>
              </span>
            </li>
          </ul>
        </span>
      </ng-container>
    </div>
  </div>
</div>
